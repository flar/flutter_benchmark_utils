<!DOCTYPE HTML>
<!-- Copyright 2020 The Flutter Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file. -->
<html>
  <head>
    <!--Load the AJAX API-->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="graphTimeline-results.js"></script>
    <script type="text/javascript">

      // Load the Visualization API and the Material chart package.
      google.charts.load('current', {'packages':['corechart']});

      // Set a callback to run when the Google Visualization API is loaded.
      google.charts.setOnLoadCallback(drawCharts);

      function drawCharts() {
        if (graphTimeline_data) {
          clearCharts();
          makeCharts(graphTimeline_data);
        }
      }

      var kBuildBeginName = 'frame_begin_times';
      var kBuildDurationName = 'frame_build_times';
      var kRenderBeginName = 'frame_rasterizer_begin_times';
      var kRenderDurationName = 'frame_rasterizer_times';

      function percentile(type, percent) {
        return graphTimeline_data[percent + 'th_percentile_frame_' + type + '_time_millis'];
      }

      function combinedKeys(resultsA, resultsB) {
        var combinedKeys = Object.keys(resultsA);
        var insertIndex = 0;
        Object.keys(resultsB).forEach((key) => {
          var index = combinedKeys.indexOf(key);
          if (index < 0) {
            combinedKeys.splice(insertIndex++, 0, key);
          } else {
            insertIndex = index+1;
          }
        });
        return combinedKeys;
      }

      function mergeKeysInto(combinedKeys, runResults) {
        Object.keys(runResults).forEach((key, value) => {
          if (combinedKeys.indexOf(key) < 0) {
            combinedKeys.push(key);
          }
        });
      }

      // All charts created
      //   charts_by_type[type] = { chart, data, options, element };
      var charts_by_type = [];

      // Callback that creates and populates a data table,
      // instantiates the pie chart, passes in the data and
      // draws it.
      function loadJSON() {
        var input = document.getElementById('file-input');
        if (input.files.length > 0) {
          var fileReader = new FileReader();
          fileReader.onload = function(e) {
            var data = jQuery.parseJSON(fileReader.result);
            AB_data = data;
            drawCharts();
          };
          fileReader.readAsText(input.files[0]);
        }
      }

      function clearCharts() {
        charts_by_type = [];
        var grid = document.getElementById('all_charts_flow');
        while (grid.firstChild) {
          grid.removeChild(grid.lastChild);
        }
      }

      function makeCharts(AB_data) {
        var build_begin_times = graphTimeline_data[kBuildBeginName];
        var build_durations = graphTimeline_data[kBuildDurationName];
        var render_begin_times = graphTimeline_data[kRenderBeginName];
        var render_durations = graphTimeline_data[kRenderDurationName];
        var grid = document.getElementById('all_charts_flow');
        grid.appendChild(makeTimeChart(render_begin_times, render_durations, 'rasterizer'));
        grid.appendChild(makeTimeChart(build_begin_times, build_durations, 'build'));
        grid.appendChild(makeDurationChart(render_durations, 'rasterizer'));
        grid.appendChild(makeDurationChart(build_durations, 'build'));
        for (var chart_key in charts_by_type) {
          var info = charts_by_type[chart_key];
          info.chart.draw(info.data, info.options);
        }
      }

      function svg2img(element) {
        var svg = element.getElementsByTagName('svg')[0];
        var xml = new XMLSerializer().serializeToString(svg);
        var svg64 = btoa(unescape(encodeURIComponent(xml)));
        var b64start = 'data:image/svg+xml;base64,';
        var image64 = b64start + svg64;
        return image64;
      }

      function clicked(type) {
        var info = charts_by_type[type];
        var canvas = document.createElement('canvas');
        var dpr = window.devicePixelRatio;
        canvas.width = info.options.width * dpr;
        canvas.height = info.options.height * dpr;
        canvas.style.width = info.options.width;
        canvas.style.height = info.options.height;
        canvas.style.display = 'none';
        var context = canvas.getContext('2d');
        var img_element = document.createElement('img');
        img_element.onload = function() {
          context.scale(dpr, dpr);
          context.drawImage(img_element, 0, 0);
          var img_data = canvas.toDataURL('image/png');
          var link = document.createElement('a');
          link.href = img_data;
          link.download = 'AB_'+type+'.png';
          link.click();
        }
        img_element.src = svg2img(info.element);
      }

      function makeDiv(id, style) {
        var div = document.createElement('div');
        div.id = id;
        div.style = style;
        for (var i = 2; i < arguments.length; i++) {
          div.appendChild(arguments[i]);
        }
        return div;
      }

      function makeButton(text, onclick) {
        var button = document.createElement('button');
        button.innerHTML = text;
        button.onclick = onclick;
        return button;
      }

      function makeTimeChart(begin_times, durations, type) {
        var indexType = 'seconds';
        if (begin_times == null) {
          indexType = 'frame';
          begin_times = [];
          var frame = 1;
          for (var dur in durations) {
            begin_times.push(frame);
            frame++;
          }
        } else {
          var adjusted_times = [];
          for (var index in begin_times) {
            adjusted_times.push(begin_times[index] / 1000.0 / 1000.0);
          }
          console.log(adjusted_times);
          begin_times = adjusted_times;
        }
        var id = 'timeline_' + type;
        var cutoff90 = percentile(type, 90);
        var cutoff99 = percentile(type, 99);
        return makeDiv(
          id,
          'padding: 5px; border-color: #black;',
          makeLineChart(begin_times, durations, id, indexType, cutoff90, cutoff99),
          makeDiv(
            'controls_' + id,
            'padding-top: 10px;',
            makeButton('Save as PNG', function() { clicked(id); }),
          ),
        );
      }

      function makeDurationChart(durations, type) {
        var id = 'duration_' + type;
        var cutoff90 = percentile(type, 90);
        var cutoff99 = percentile(type, 99);
        return makeDiv(
          id,
          'padding: 5px; border-color: #black;',
          makeAreaChart(durations, cutoff90, cutoff99, id),
          makeDiv(
            'controls_' + id,
            'padding-top: 10px;',
            makeButton('Save as PNG', function() { clicked(id); }),
          ),
        );
      }

      function color_for(dur, cutoff90, cutoff99) {
        if (dur < cutoff90) return 'green';
        if (dur < cutoff99) return 'orange';
        return 'red';
      }

      function label_for(dur, cutoff90, cutoff99) {
        if (dur < cutoff90) return 'Nominal';
        if (dur < cutoff99) return '90th percentile';
        return '99th percentile';
      }

      function makeLineChart(begin_times, durations, type, indexType, cutoff90, cutoff99) {
        var data = new google.visualization.DataTable();
        data.addColumn('number', 'frame');
        data.addColumn('number', 'duration in ms');
        data.addColumn({ role: 'style' });

        for (var i = 0; i < durations.length; i++) {
          var dur = durations[i] / 1000.0;
          var color = color_for(dur, cutoff90, cutoff99);
          data.addRow([ begin_times[i], dur, color ]);
        }

        var options = {
          title: type,
          legend: {
            position: 'none',
          },
          //bars: 'horizontal',
          chartArea: {
            left: 30,
            top:  50,
            right: 20,
            bottom: 20,
          },
          vAxis: {
            minValue: 0,
            textStyle: {
              fontSize: 12,
            },
          },
          width: 1200,
          height: 300,
        };

        var chart_div = makeDiv('chart_' + type, null);
        var chart = new google.visualization.AreaChart(chart_div);
        charts_by_type[type] = {
          chart: chart,
          data: data,
          options: options,
          element: chart_div
        };
        return chart_div;
      }

      function makeAreaChart(durations, cutoff90, cutoff99, type) {
        var sorted_durations = [ ...durations ].sort((a, b) => a - b);

        var data = new google.visualization.DataTable();
        data.addColumn('string', 'range');
        data.addColumn('number', 'duration in ms');
        data.addColumn({ role: 'style' });

        for (var index in sorted_durations) {
          var dur = sorted_durations[index] / 1000.0;
          var label = label_for(dur, cutoff90, cutoff99);
          var color = color_for(dur, cutoff90, cutoff99);
          data.addRow([ label, dur, color ]);
        }

        var options = {
          title: type,
          legend: {
            position: 'none',
          },
          //bars: 'horizontal',
          chartArea: {
            left: 30,
            top:  50,
            right: 20,
            bottom: 20,
          },
          vAxis: {
            minValue: 0,
            textStyle: {
              fontSize: 12,
            },
          },
          width: 1200,
          height: 300,
        };

        var chart_div = makeDiv('chart_' + type, null);
        var chart = new google.visualization.AreaChart(chart_div);
        charts_by_type[type] = {
          chart: chart,
          data: data,
          options: options,
          element: chart_div
        };
        return chart_div;
      }
    </script>
  </head>

  <body>
  <div id='all_charts_header'>
    <button onclick="document.getElementById('file-input').click();">Load results file</button>
    <input id="file-input" type="file" name="name" style="display: none;" accept=".json" oninput="loadJSON()"/>
  </div>
  <div id='all_charts_flow'
       style="display: flex; flex-wrap: wrap;">
  </div>
  </body>
</html>
